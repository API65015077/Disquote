<!DOCTYPE html>
<html lang="en" ng-app="TestApp">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Disquote</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', path='/assets/favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/style/style-chatboardv2.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/style/style-setting.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/style/style-sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/style/style-profile-status.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/style/style-mainfriend.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/style/style-chat.css') }}">
    
    <!-- <link rel="stylesheet" href="{{ url_for('static', path='/style/style-chatboard-bak.css') }}"> -->
    <script src="/static/script/jquery.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>

<ng-controller="testCtrl">
    <noscript>Please enable JavaScript to access this website.</noscript>
    
    <!-- Setting -->
    <div class="settpage" id="settpage">
        <section class="container_setting">
    
            <div class="column1">
                <div class="section">
                <div class="section_black"></div>
                <div class="section_s">
                <a style="font-family:Mukta"><b>USER SETTING</b></a>
                    <div class="btn_a">
                        <li><button class="btn_s active"><a href="#">My Account</a></button></li>
                        <!-- <li><button class="btn_s"><a href="#">Profiles</a></button></li> -->
                    </div>
                    <!-- <div class="line-4">
                        <hr>
                    </div> -->
                <!-- <a style="font-family:Mukta"><b>APP SETTING</b></a>
                    <div class="btn_a">
                        <li><button class="btn_s "><a href="#">Vocie & Video</a></button></li>
                        
                        
                    </div> -->
                
        
                    <div class="line-4">
                        <hr>
                    </div>
                        <a style="font-family:Mukta"><b>Program</b></a>
                    <div class="btn_a">
                    <li ><button class="btn_s" id="logoutmenu"><a href="#">Log out</a></button></li>
                        
                        
                    </div>
                        <div class="line-4">
                            <hr>
                        </div>
                </div>
                </div>
            </div>
        
            <div class="column2">
                <div class="section_content">
                    <div class="MyAccount">
                        <a style="font-family:Mukta" class="content_head"><b>My Account</b></a>
                        <br>
                        <br>
                        <div class ="card-account" style=" width: 100%; height: 350px; border-radius: 10px; ">
                                <div class="todd" style="background-color: aliceblue; height: 50px;  border-radius: 10px 10px 0px 0px;"></div>
                                <div class="detail" style="background-color: rgba(30, 31,34, 1); height: 250px;  border-radius: 0px 0px 10px 10px; ">
                                    <div class="Profile-Flist" style="margin-left:10px; display: flex;">
                                        <!-- <img src=""  alt="" id="AvatarAccoutDisplay" > -->
                                        
                                            <h2 style="text-align: center; justify-content: center; font-size: 20px;" id="NameAccoutDisplay">Named</h2>
                                    </div>
                                   
                                    <div class="in-detail" style="background-color: rgba(43, 45,49, 1); height: 150px;margin-left: 20px; margin-right: 20px;   border-radius: 10px 10px 10px 10px; " >
                                    
                                        <li style="margin-left: 10px; " >
                                            <p style="font-family: Mukta; font-size: 14px; color:rgba(181, 186,193, 1)">USERNAME <br>
                                            <a style="font-size: 20px; "id="NameAccoutDisplayDetail"></a></p>
                                        </li>
                                        <!-- <li style="margin-left: 10px">
                                            <p style="font-family: Mukta; font-size: 14px; color:rgba(181, 186,193, 1)">EMAIL <br>
                                                <a style="font-size: 20px; "id="EmailAccoutDisplayDetail"></a></p>
                                        </li> -->
                                    </div>
                                </div>

                        </div>
                    </div>
                    <div class="escbtn">

                        <button type="texr" style="font-family:mukta" class="btn_out_esc" id="btn_out_esc" ><a class="iconx" ><i class="fa-solid fa-xmark"></i></a>
                            <br>
                            ESC
                        </button>
                    </div>
                    <div class="this_is_myaccount">
                        <!-- <a class="linedown">--------------</a> -->
                        
                    </div>
                </div>
            
            </div>
        
        
            <div id="popupout">
                    
                
        
                    <div class="popup_log_content">
                        <div class="head_text"><b>Log Out</b></div>
                        <p style="font-family:mukta">Are you sure you want to logout?</p>
                    
                        
                        <div class="btn_section">
                        
                    
                        <a href="#" class="btn_cancel" id="btn_cancel_out"  style="font-family:mukta">Cancel</a>
                        <button type="text" style="font-family:mukta" class="btn_out" id="btn_out" >Log Out</button>
                        </div>
                    
                        
                        </div>
                
                
                </div>
                </section>
    </div>
    


    <div class="rootDiv" id="rootDiv">
        
        <div class="side-bar">
            <div id="chat-menu" class="nav">
                <!-- guild -->
                <div id="guild">
                    <div class="guildSettings">
                    
                    </div>
                    
                    <div class="guildSettings">
                        <div class="navguild">
                            <div class="guild-opener">
                                <div class="navGuildItems">
                                    <!-- <h4 class="guildSelectorName">Server Name</h4> -->
                                    <div class="navbar">
                                        <div class="logo"> <a id="nameofserver"></a></div>
                    
                                        <div class="toggle_btn"> <i class="fa-solid fa-chevron-down"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="channel">
                            <div class="textch">
                                <a>Text Channel</a>
                                <a href="#" class="add_btn" id="add_btnTxt"><i class="fa-solid fa-plus"></i></a>
                                <div class="ch_room">
                                    <ul id="todoListTxt">
                                        <!-- <li><i class="fa fa-hashtag"></i><a href="#" style="font-family: Mukta;">General</a></li></ul> -->
                                    </ul>
                                </div>
                            </div>
                            <div class="voicech">
                                <a>Voice Channel</a>
                                <a href="#" class="add_btn" id="add_btnV"><i class="fa-solid fa-plus"></i></a>
                                <div class="voice_room">
                                    <ul id="todoListVoc">
                                        <!-- <li><i class="fa fa-hashtag"></i><a href="#" style="font-family: Mukta;">General</a></li></ul> -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="popupTxt">
                            <form id="todoFormTxt">
                                <div class="popup_add_content" style="width: 360px; height: 320px; padding-left: 20px; padding-top: 10px;">
                                    <h3 style="font-family:mukta; margin-left: 20x;">Create Channel</h3>
                                    <h6 style="font-family:mukta; margin-left: 20x;">Text Channel</h6>
                    
                                    <h4 style="font-family:mukta">Channel Name</h4><br>
                                    <input type="text" placeholder="Name Channel" style="font-family:mukta; width: 300px; "id="todoInputTxt">
                                    <button type="submit" style="font-family:mukta" class="btn_add">Create Channel</button>
                                    <a href="#" class="btn_cancel" id="btn_cancelTxt" style="font-family:mukta">Cancel</a>
                                </div>
                            </form>
                        </div>
                        <div id="popupV">
                            <form id="todoFormV">
                                <div class="popup_add_content" style="width: 360px; height: 320px; padding-left: 20px; padding-top: 10px;">
                                    <h3 style="font-family:mukta">Create Channel</h3>
                                    <h6 style="font-family:mukta">Voice Channel</h6>
                    
                                    <h4 style="font-family:mukta">Channel Name</h4><br>
                                    <input type="text" placeholder="Name Channel" style="font-family:mukta" id="todoInputV">
                                    <button type="submit" style="font-family:mukta" class="btn_add">Create Channel</button>
                                    <a href="#" class="btn_cancel" id="btn_cancelV" style="font-family:mukta">Cancel</a>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="dropdown_menu">
                        <li><a href="#">Server Setting</a></li>
                        <li><a href="#" id="copy-invite">invite Link</a></li>
                        <li><a href="#">Leave Server</a></li>
                        <li><a href="#" class="action_btn">Leave</a></li>
                    </div>
                </div>
                <!-- guild -->
            </div>
            <div id="user-box" class="userBox">
                <img src="https://cdn.discordapp.com/embed/avatars/0.png" alt="avatar" id="avatar" class="userAvatar">
                <div class="status" id="status">
                    <div class="round online_status"></div>

                </div>
                <div class="Username" id="userinfo">
                    <h4 id="username" class="username">Username</h4>
                    <h6 id="discriminator" class="discriminator">#1234</h6>
                </div>
                <div class="usermenuicons">
                    <div class="mic" id="micToggle"></div>
                    <div class="headphone" id="headphoneToggle"></div>
                    <div class="settings" id="settingsToggle" ></div>
                </div>
            </div>
        </div>
        <div id="nav-placeholder" class="servers">
            <!-- load navbar.html -->
            <div id="dm" class="homebutton">
                <svg class="homeIcon" aria-hidden="false" width="28" height="20" viewBox="0 0 28 20">
                    <path fill="#FFFFFF"
                        d="M20.6644 20C20.6644 20 19.8014 18.9762 19.0822 18.0714C22.2226 17.1905 23.4212 15.2381 23.4212 15.2381C22.4384 15.881 21.5034 16.3334 20.6644 16.6429C19.4658 17.1429 18.3151 17.4762 17.1884 17.6667C14.887 18.0953 12.7774 17.9762 10.9795 17.6429C9.61301 17.381 8.43836 17 7.45548 16.6191C6.90411 16.4048 6.30479 16.1429 5.70548 15.8096C5.63356 15.7619 5.56164 15.7381 5.48973 15.6905C5.44178 15.6667 5.41781 15.6429 5.39384 15.6191C4.96233 15.381 4.7226 15.2143 4.7226 15.2143C4.7226 15.2143 5.87329 17.1191 8.91781 18.0238C8.19863 18.9286 7.31164 20 7.31164 20C2.0137 19.8333 0 16.381 0 16.381C0 8.7144 3.45205 2.50017 3.45205 2.50017C6.90411 -0.07123 10.1884 0.000197861 10.1884 0.000197861L10.4281 0.285909C6.11301 1.52399 4.12329 3.40493 4.12329 3.40493C4.12329 3.40493 4.65068 3.11921 5.53767 2.71446C8.10274 1.59542 10.1404 1.2859 10.9795 1.21447C11.1233 1.19066 11.2432 1.16685 11.387 1.16685C12.8493 0.976379 14.5034 0.92876 16.2295 1.11923C18.5068 1.38114 20.9521 2.0478 23.4452 3.40493C23.4452 3.40493 21.5514 1.61923 17.476 0.381146L17.8116 0.000197861C17.8116 0.000197861 21.0959 -0.07123 24.5479 2.50017C24.5479 2.50017 28 8.7144 28 16.381C28 16.381 25.9623 19.8333 20.6644 20ZM9.51712 8.88106C8.15068 8.88106 7.07192 10.0715 7.07192 11.5239C7.07192 12.9763 8.17466 14.1667 9.51712 14.1667C10.8836 14.1667 11.9623 12.9763 11.9623 11.5239C11.9863 10.0715 10.8836 8.88106 9.51712 8.88106ZM18.2671 8.88106C16.9007 8.88106 15.8219 10.0715 15.8219 11.5239C15.8219 12.9763 16.9247 14.1667 18.2671 14.1667C19.6336 14.1667 20.7123 12.9763 20.7123 11.5239C20.7123 10.0715 19.6336 8.88106 18.2671 8.88106Z">
                    </path>
                </svg>
            </div>
            <hr class="server-divider " >
            <div  id="server">
            </div>
            <div class="server invite" id="invite">
                <p class="inviteButton">+</p>
            </div>

            <div id="createserver" class="servermodal">
                <!-- Modal content -->
                <div class="modal-content">
                    <span class="close" id="closeCreateServer">&times;</span>
                    <h2>Customize your server</h2>
                    <p>Give your new server a personality with a name and an icon. You can always change it later.</p>
                    <form method="post" action="/channels/create_server" enctype="multipart/form-data">
                        <div class="uploadCreateRoom">
                            <img src="{{ url_for('static', path='assets/Upload.png') }}" width="80" height="80" alt="" >
                                <div class ="round">
                                    <input type ="file" name="image" id="fileupload">
                                    <i class="fa-solid fa-circle-plus" style="color : #fff;"></i>
                                </div>
                        </div>
                        
                        <!-- ใช้สำหรับ Profile ส่วนสถานะเปลี่ยนที่ Class round  จะมี online offlie idle (สั่งเปลี่ยน class .round-idle ด้วย Display block)
                        ใช้กับ css ไฟล์ profile-status 
                        <div class="Profile">
                            <img src="{{ url_for('static', path='assets/avatarprofile.png') }}" width="80" height="80" alt="" >
                                <div class ="round idle">
                                    
                                        <div class="round-idle"></div>
                                    
                                </div>
                        </div> -->


                        <div class="roomnameinput">
                            <h4>SERVER NAME</h4>
                            <input type="text" required="true" id="serverName" name="name" class="inputnameserver">
                            <br><br> <br> 
                            <div class="forbtn"> <div></div>
                                <div>
                                    <button type="submit" value="Create" class="btncreate"> Create </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
        <div id="chat-board" class="container">
           <div id="guild-board" >
                <div class="in-container" style="height: 100%;">
                
                    <div class="nav-chat">
                
                        <div class="nav-menu">
                            <div class="icon-menu-chat">
                                <img src="{{ url_for('static', path='/assets/pin.ico') }}" alt="pin">
                            </div>
                            <div class="icon-menu-chat">
                                <img src="{{ url_for('static', path='/assets/member.png') }}" alt="member">
                            </div>
                            <div class="icon-menu-chat">
                                <h5>member?</h5>
                            </div>
                            <div class="search-menu-chat">
                                <input class="search-chat" type="text" placeholder="Search">
                                <button class="search-btn"> <img src="{{ url_for('static', path='/assets/search-icon.png') }}"
                                        alt=""></button>
                
                            </div>
                
                
                        </div>
                    </div>
                
                    <div class="chat-send" id='chat-send'>
                        <div class="chatslide" id="loadfetchsend">
                            <div class="panelchat">
                                <div class="chat-item-main">
                
                                    <h2> Welcome to <br> <label id="sever_name_show"></label> Server </h2>
                                    <p>This is the beginning of this server.</p>
                                </div>
                                <div class="line-4">
                                    <hr>
                                </div>
                                <div class="chat-item" id="todo-chat-send">
                                    <div class="chat-item-content">
                
                                        <!-- <div class="chat-to-send">
                                                <div class="Profile-Direct" style="width: 60px;" >
                                                    <img src="{{ url_for('static', path='assets/disquote.png') }}"  alt="" >    
                                                </div>
                                                <div class="content-chat">
                                                    <div class="namechat">
                                                        <h6><span class="name">Name</span>
                                                            <span class ="date">09/76/333 17:09 PM</span>
                                                        </h6>
                                                        <div class="conchat">
                                                            dfghjkl
                                                        </div>
                                                    </div>
                                                    
                                                </div>
                                            </div> -->
                
                                    </div>
                                </div>
                            </div>
                        </div>
                
                        <div id="text-send" class="sendinput" style="height: 60px;;">
                            <form id="sendMessage" style="
                            width: 100%;">
                                <input type="text" placeholder="Enter a Username#0000" id="sendtextchat">
                            </form>
                            <button id='sticker'>
                                <i class="fa-regular fa-face-smile fa-xl"> </i>
                            </button>
                            <button>
                                <i class="fa-solid fa-note-sticky fa-lg"></i>
                            </button>
                        </div>
                
                    </div>
                
                    <div class="members">
                        <div class="box-member">
                            <div class="online-member-box">
                                <h4>ONLINE -- x </h4>
                                <div class="online-member">
                                    <button class="Member-room">
                                        <div class="gridProfile">
                                            <div class="Profile-Direct" style="width: 70px;">
                                                <img src="{{ url_for('static', path='assets/disquote.png') }}" alt="">
                                                <div class="round online" style="width: 10px;
                                                    height: 10px; margin-bottom: 10px;
                                                    margin-right: 10px;
                                                    border :5px solid rgba(43, 45,49, 1);">
                                                </div>
                                            </div>
                                            <div class="txtnamedirect">
                                                <label id="online_name"></label>
                                            </div>
                                        </div>
                                    </button>
                
                                    <button class="Member-room">
                                        <div class="gridProfile">
                                            <div class="Profile-Direct" style="width: 70px;">
                                                <img src="{{ url_for('static', path='assets/disquote.png') }}" alt="">
                                                <div class="round online" style="width: 10px;
                                                        height: 10px; margin-bottom: 10px;
                                                        margin-right: 10px;
                                                        border :5px solid rgba(43, 45,49, 1);">
                                                </div>
                                            </div>
                                            <div class="txtnamedirect">
                                                <label>Member2</label>
                                            </div>
                                        </div>
                                    </button>
                
                
                
                
                                </div>
                
                            </div>
                
                            <div class="offline-member-box">
                                <h4>OFFLINE -- x </h4>
                                <div class="offline-member">
                
                                    <button class="Member-room">
                                        <div class="gridProfile">
                                            <div class="Profile-Direct" style="width: 70px;">
                                                <img src="{{ url_for('static', path='assets/disquote.png') }}" alt="">
                                                <div class="round offline-direct" style="width: 10px;
                                                    height: 10px; margin-bottom: 10px;
                                                    margin-right: 10px; 
                                                    border :5px solid rgba(43, 45,49, 1)"></div>
                
                                            </div>
                                            <div class="txtnamedirect">
                                                <label>Member3</label>
                                            </div>
                                        </div>
                                    </button>
                
                
                                    <button class="Member-room">
                                        <div class="gridProfile">
                                            <div class="Profile-Direct" style="width: 70px;">
                                                <img src="{{ url_for('static', path='assets/disquote.png') }}" alt="">
                                                <div class="round offline-direct" style="width: 10px;
                                                    height: 10px; margin-bottom: 10px;
                                                    margin-right: 10px;
                                                    border :5px solid rgba(43, 45,49, 1);"></div>
                                            </div>
                                            <div class="txtnamedirect">
                                                <label>Member4</label>
                                            </div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                
                    </div>
                
                </div>
            </div>
            
        </div>

        
    </div>
    
    <!-- get user info -->
    <!-- user-box section -->
    <script src="/static/script/user-box.js" defer></script>
    <script>
        authen();
        //var t = setInterval(authen, 20000);

        async function getinfo(url) {
            let response = await fetch(url, {
                method: 'GET',
                credentials: 'include'
            }).then(async function (response) {
                return response.json();
            }).then(async function (data) {
                console.log("info",data);
                var username = document.getElementById("username");
                username.innerHTML = data.username;
                localStorage.setItem("username", data.username);
                localStorage.setItem("id-user", data.tag);
                // localStorage.setItem("AvatarU" ,data.avatar);
                
                //let avatar = document.getElementById("avatar");
                //avatar.src = `/image/server_avartar/${data.avatar}`;
                await fetch(`/image/user_avartar/${data.avatar}`, {
                    method: 'GET',
                    credentials: 'include'
                }).then(async function (response) {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        throw new Error(`Failed to fetch image: ${response.status} ${response.statusText}`);
                    }
                }).then(async function (blob) {
                    if (blob) {
                        avatar.src = URL.createObjectURL(blob);
                    } else {
                        throw new Error("Failed to convert image to blob");
                    }
                }).catch(function (error) {
                    console.error(error);
                    // handle error by showing a message to the user or logging it to a server
                });
                let discriminator = document.getElementById("discriminator");
                discriminator.innerHTML = "#" + data.tag;
            })
        }

        async function getJSON() {
            return fetch(`/account/auth`, {
                method: 'GET',
                credentials: 'include'
            })
                .then((response) => response.json())
                .then((responseJson) => { return responseJson });
        }
        async function authen() {
            url = `/account/auth`;
            const json = await this.getJSON();
            if (json.detail == "Authorized") {
                await getinfo('/account/me');
                console.log("Authorized")
            }
            else{
                window.location.href = "/account/login";
            }
        }

    </script>


    <!-- TODO: get server list && create server -->
        <script>
        async function get_server_list() {
            return fetch(`/channels/getlist`, { // ลองเข้า url นี้
                method: 'GET',
                credentials: 'include'
            })
                .then((response) => response.json())
                .then((responseJson) => { return responseJson })
                // .then((response) => {console.log(response)});
        }
        async function loop_server() {
            // Get the server list data
            await get_server_list() // รอให้ get_server_list() ทำงานเสร็จก่อน
                .then(async (data) => { //json ที่ได้จาก get_server_list() จะถูกส่งมาที่ data
                    console.log(data);
                    // ลบ server ทั้งหมดที่มีอยู่ในหน้าเว็บออกก่อน
                    let server = document.getElementById("server");
                    server.style.display = 'none';
                    while (server.firstChild) {
                        server.removeChild(server.firstChild);
                    }
                    // สร้าง server ใหม่ตามจำนวนที่ได้จาก get_server_list()
                
                    for (let i = 0; i < data.length; i++) {
                        let server = document.getElementById("server");
                        let ddiv = document.createElement("div");
                        ddiv.classList.add("server");
                        ddiv.id = data[i].id;
                        // const ch = data[i];
                        // console.log(ch);
                        ddiv.onclick = function () {
                            window.location = `/channels/${data[i].id}`;
                            localStorage.setItem("serverID", data[i].id);
                            localStorage.setItem("serverName", data[i].name);
                            localStorage.setItem("invitation", data[i].invite_code);
                            var $sid = data[i].owner;
                        }; 
                        ddiv.onmouseover = function () {
                            //display server name in popup label on mouse over server
                            let servername = data[i].name;
                            ddiv.title = servername;
                        };
                        ddiv.addEventListener("mouseout", function () {
                            let popup = document.querySelector(".serverpopup");
                            if (popup) {
                                popup.remove();
                            }
                        });
                        if (data[i].image){
                            //สำหรับ server ที่มีรูป
                            let img = document.createElement("img");
                            img.classList.add("servericon");
                            //img.src = data[i].image;
                            await fetch(`/image/server_avartar/${data[i].image}`, {
                                method: 'GET',
                                credentials: 'include'
                            }).then(async function (response) {
                                if (response.ok) {
                                    return response.blob();
                                } else {
                                    throw new Error(`Failed to fetch image: ${response.status} ${response.statusText}`);
                                }
                            }).then(async function (blob) {
                                if (blob) {
                                    img.src = URL.createObjectURL(blob);
                                } else {
                                    throw new Error("Failed to convert image to blob");
                                }
                            }).catch(function (error) {
                                console.error(error);
                                // handle error by showing a message to the user or logging it to a server
                            });
                            ddiv.appendChild(img);
                            server.appendChild(ddiv);
                        }else{
                            //สำหรับ server ที่ไม่มีรูป
                            let pp = document.createElement("p");
                            pp.classList.add("servericon");
                            let words = data[i].name.split(' ');
                            let name = words[0].slice(0, 2).toUpperCase();
                            pp.innerHTML = name;
                            ddiv.appendChild(pp);
                            server.appendChild(ddiv);
                        }
                    }
                    server.style.display = 'block';
                });
        }

        loop_server();



        var modal = document.getElementById("createserver");
        var btn = document.getElementById("invite");
        var span = document.getElementsByClassName("close")[0];
        btn.onclick = function () {
            modal.style.display = "block";
        }
        span.onclick = function () {
            modal.style.display = "none";
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }



    </script>

    <!-- TODO: button setting -->
    <script>
        //script ของ setting  div
        const settingprogram = document.getElementById('settingsToggle');
        const divroot = document.getElementById('rootDiv');
        const divsetting = document.getElementById('settpage');
        const closebtnsetting = document.getElementById('btn_out_esc');
    
        settingprogram.addEventListener('click', () => {
            divroot.style.display ='none';
            divsetting.classList.add("show");
        });
    
        closebtnsetting.addEventListener('click', () => {
            divroot.style.display ='grid';
            divsetting.classList.remove("show");
        });

            const logoutmenu = document.getElementById('logoutmenu');
            const logoutcancel = document.getElementById('btn_cancel_out');
            const Popupout = document.getElementById('popupout');
            logoutmenu.addEventListener('click', () => {
                Popupout.style.display ='block';
            });
            logoutcancel.addEventListener('click', () => {
                Popupout.style.display ='none';
            });

        const log_out_btn = document.getElementById('btn_out');
        log_out_btn.addEventListener('click', () => {
            window.location.href = "/account/logout";
        });

         // -----------------------change to dm container-----------------------------------
        document.getElementById('dm').addEventListener('click' , (e) =>{
            $(document).ready(function() { $("#chat-menu").load("/chat-dm");})  
            $(document).ready(function() { $("#chat-board").load("/container-dm");})
        });

    </script>

    {% if svdm %}
    <script>
        var link = document.getElementById('dm');
         // var friends = document.getElementById('friendlistload');
        link.click();
        // friends.click();
    </script>
    {% endif %} 

    <!-- TODO: getchannel && create channel -->
    {% if ch %}
    <script>
        // $(document).ready(function () { $("#chat-menu").load("/chat-guild"); })
        // $(document).ready(function () { $("#chat-board").load("/container-server"); })

        // $(document).ready(function () {
                 // $("#chat-menu").load("/chat-guild");
        //         $("#chat-board").load("/container-server");
        // })

        const currentUrl = window.location.href;
        const svid = currentUrl.split("/").pop(); 
        async function get_ch_list() { 
                return fetch(`/channels/${svid}/get_ch_list`, { // ลองเข้า url นี้
                    method: 'GET',
                    credentials: 'include'
                })
                    .then((response) => response.json())
                    .then((responseJson) => { return responseJson });
            }

            async function loop_channels() {
                await get_ch_list().then(async (ch) => {
                    console.log("chanel",ch);/////ch data

                    let guildTch = document.getElementById('todoListTxt');
                    let guildVch = document.getElementById('todoListVoc');
                    let displaychat = document.getElementById('chat-send');

                    for (j = 0; j < ch.length; j++) {

                        let guildli = document.createElement('li');
                        let guilda = document.createElement('a');
                        let guildi = document.createElement('i');

                        guilda.id = ch[j].id;
                        guilda.innerHTML = ch[j].name;
                        
                        guildli.appendChild(guildi);
                        guildli.appendChild(guilda);

                        if (ch[j].type == 'text') {
                            guildi.classList.add('fa', 'fa-hashtag');
                            guilda.classList.add('textchat');
                            guildTch.append(guildli);
                        } else if (ch[j].type == 'voice') {
                            guildi.classList.add('fa', 'fa-volume-up');
                            guilda.classList.add('voicechat');
                            guildVch.append(guildli);
                        }
                        // console.log("ch: ", ch[j].messages[0]);

                        let chat = document.getElementById(`${ch[j].id}`);
                        chat.onclick = function () {
                            console.log("ch: ", this.id, "type:", this.classList[0]);
                            if (this.classList[0] == 'textchat') {
                                localStorage.setItem("channel_id", this.id);
                                //$(document).ready(function() { $("#chat-board").load(`/container-server`);})
                                // console.log(ch[chat].messages.content)
                                displaychat.style.display = 'grid';
                            } else if (this.classList[0] == 'voicechat') {
                                // $(document).ready(function() { $("#chat-board").load(`/container-server`);})
                                displaychat.style.display = 'none';
                            }
                        }
                    }
                });
            }
            

            loop_channels();
            
        // const roomName = document.getElementById('roomName')

    </script>
    {% endif %}

    <!-- TODO: setting btn -->
    <script>
        var id_user = (localStorage.getItem("id-user"));
            var email_detail = (localStorage.getItem("email"));
            var Avatar_detail = (localStorage.getItem("AvatarU"));

            var nameserver = (localStorage.getItem("serverName"));
            var usernameD = (localStorage.getItem("username"));
            let name_server = document.getElementById("nameofserver");
            let SettingAccout = document.getElementById("NameAccoutDisplay");

            let SettingAccoutDetail = document.getElementById("NameAccoutDisplayDetail");
            let SettingAccoutDetailEmail = document.getElementById("EmailAccoutDisplayDetail");


            name_server.innerHTML = nameserver;
            SettingAccout.innerHTML = usernameD + '#' + id_user;
            SettingAccoutDetail.innerHTML = usernameD + '#' + id_user;
            // AvatarAccout.src=Avatar_detail;


            const clickA = document.getElementById('NameAccoutDisplay');
            clickA.addEventListener('click', () => {
                navigator.clipboard.writeText(usernameD + '#' + id_user);
                console.log('copied');
                alert('Username Copied');
            })
    </script>

    <!-- TODO:  dropdown sidebar menu-->
    <script>
    
        // const roomName = document.getElementById('roomName')
    
        const toggleBtn = document.querySelector('.navbar')
        const toggleBtnIcon = document.querySelector('.toggle_btn i')
        const dropDownMenu = document.querySelector('.dropdown_menu')
    
        toggleBtn.onclick = function () {
        dropDownMenu.classList.toggle('open')
        const isOpen = dropDownMenu.classList.contains('open')
    
        toggleBtnIcon.classList = isOpen
        ? 'fa-solid fa-xmark'
        : 'fa-solid fa-chevron-down'
        }
    
    
        const addBtnTxt = document.getElementById('add_btnTxt');
        const closeBtnTxt = document.getElementById('btn_cancelTxt');
    
        const addBtnV = document.getElementById('add_btnV');
        const closeBtnV = document.getElementById('btn_cancelV');
        const popupTxt = document.getElementById('popupTxt');
        const todoFormTxt = document.getElementById('todoFormTxt');
        const todoInputTxt = document.getElementById('todoInputTxt');
        const todoListTxt = document.getElementById('todoListTxt');
    
        const popupV = document.getElementById('popupV');
        const todoFormV = document.getElementById('todoFormV');
        const todoInputV = document.getElementById('todoInputV');
        const todoListV = document.getElementById('todoListV');
    
    
        
    
        addBtnTxt.addEventListener('click', () => {
            popupTxt.style.display ='block';
        });
    
        closeBtnTxt.addEventListener('click', () => {
            popupTxt.style.display = 'none';
            });
        
        addBtnV.addEventListener('click', () => {
                popupV.style.display ='block';
            });
    
        closeBtnV.addEventListener('click', () => {
                popupV.style.display = 'none';
                });
                //Send Msg

        todoFormTxt.addEventListener('submit', (e) => {
        e.preventDefault();
        const todoText = todoInputTxt.value;

               
                    if (!todoText) {
                        addBtnTxt.disabled=true;
                        alert("ค่าว่าง"); 
                }
                // const todoItem = document.createElement('li');
                // const todoLink = document.createElement('a');
                // const todoIcon = document.createElement('i');
                // todoLink.href = todoText;
                // todoLink.style.fontFamily = 'Mukta';
                // todoLink.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;' + todoText;
                // todoIcon.classList.add('fa', 'fa-volume-high');
                // todoItem.appendChild(todoIcon);
                // todoItem.appendChild(todoLink);
                // todoListV.appendChild(todoItem);
                // todoInputV.value = '';

                // let Servid = parseInt(svid);
                else  {
                    const regex = /^[a-zA-Z0-9\s]+$/;
                    if (!regex.test(todoText)) {
                        event.target.value = todoText.slice(0, -1);
                        alert("ห้ามใช้อักษระพิเศษ"); 
                        
                    }
                else {
                let type1 ='text'
                
                let Servid = parseInt(svid);
                async function CreateCh(url = `/channels/${Servid}/create_channel`, data = {
                    ch_name: todoText,
                    ch_type: type1,
                    ch_category: 'Cat'
                    }) {
                    try {
                        const response = await fetch(url, {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        redirect: 'follow',
                        referrerPolicy: 'no-referrer',
                        body: JSON.stringify(data)
                        }).then(response => response.json())
                        .then(data => {
                            if (data.detail == 'success') {
                                window.location.href = `/channels/${Servid}`;
                            } else {
                                console.log('Channel not created');
                            }
                        })
                    } catch (error) {
                        console.error(error);
                    }
                    }

                    CreateCh();
                    
                    

                console.log(todoText);
                todoInputV.value = '';
                popupTxt.style.display = 'none';
                
                
        }}});
    
        todoFormV.addEventListener('submit', (e) => {
            e.preventDefault();
            const todoText = todoInputV.value;
            if (todoText) {
                let type2 ='voice'
                let Servid = parseInt(svid);
                async function CreateCh(url = `/channels/${Servid}/create_channel`, data = {
                    ch_name: todoText,
                    ch_type: type2,
                    ch_category: 'Cat'
                    }) {
                    try {
                        const response = await fetch(url, {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        redirect: 'follow',
                        referrerPolicy: 'no-referrer',
                        body: JSON.stringify(data)
                        }).then(response => response.json())
                            .then(data => {
                                if (data.detail == 'success') {
                                    window.location.href = `/channels/${Servid}`;
                                } else {
                                    console.log('Channel not created');
                                }
                            })
                    } catch (error) {
                        console.error(error);
                    }
                    }

                    CreateCh();
                    
                console.log(todoText);
                
                todoInputV.value = '';
                popupTxt.style.display = 'none';
                todoInputV.value = '';
                popupV.style.display = 'none';
                
            }
            
            });
            
    
    
    </script>

    
    <!-- TODO:สร้างการส่งข้อความ -->
    <script>

        const todochatsend = document.getElementById('todo-chat-send');
        const InputSendMessage = document.getElementById('sendMessage');

        const textsend = document.getElementById('sendtextchat');

        InputSendMessage.addEventListener('submit', (e) => {
            e.preventDefault();
            var sendtext = textsend.value;
            if (sendtext) {
                // const todochattosend = document.createElement('div');
                // const todoProfileDirect = document.createElement('div');
                // const todocontentchat = document.createElement('div');
                // const todoimage = document.createElement('img');
               
                // const todonamechat = document.createElement('div');
                // const todoconchat = document.createElement('div');
                // const todoitem31 =document.createElement('div');
                

                // const todoHeadSix = document.createElement('h6');
                // const todoSpan1 = document.createElement('span');
                // const todoSpan2 = document.createElement('span');


                // const todate = new Date();
                // const tododateDate = new Date().toISOString().split('T')[0];
                
                // let namemeM = (localStorage.getItem("username"));
                
                // todate.getHours() + ":" + todate.getMinutes() 
                

                // const nameMember = 'Name ';

                // todochattosend.classList.add('chat-to-send');

                // todoProfileDirect.classList.add('Profile-Direct');
                // todoProfileDirect.style.width='60px';


                // todoimage.src ="{{ url_for('static', path='/assets/disquote.png') }}";

                // todoProfileDirect.appendChild(todoimage);

                // //เสร็จของProfileDirect



                // //addclass contentchat
                // todocontentchat.classList.add('content-chat');

                // //addclass namechat
                // todonamechat.classList.add('namechat');
                // //addclass conchat
                // todoconchat.classList.add('conchat');
                // //เอาText เข้า         
                // todoconchat.innerHTML=sendtext;
                // //addclass span1
                // todoSpan1.classList.add('name');
                // //เอาtext เข้า
                // todoSpan1.innerHTML=namemeM+'  ';
                
                // //todoSpan1.innerHTML=nameMember;
                // //addclass span1
                // todoSpan2.classList.add('date');
                // //เอาtext เข้า
                // todoSpan2.innerHTML=tododateDate   + '  ' + todate.getHours() + ":" + todate.getMinutes() ;
                // todoHeadSix.appendChild(todoSpan1);
                // todoHeadSix.appendChild(todoSpan2);
                // //เอา h6 และ และ div  conchat
                // todonamechat.appendChild(todoHeadSix);
                // todonamechat.appendChild(todoconchat);
                // todocontentchat.appendChild(todonamechat);
                // todochattosend.appendChild(todoProfileDirect);
                // todochattosend.appendChild(todocontentchat);
                // todochatsend.appendChild(todochattosend);
                // textsend.value = '';

                //SendMsg
                let chanel_id = localStorage.getItem("channel_id");
                let j = parseInt(chanel_id);
                let k = parseInt(svid);

                async function postData(url = `/msg/${j}/sendmsg`, data = { 
                    chanel_id: j ,
                    server_id: k,
                    msg: sendtext
                }) {
                        const response = await fetch(url, {
                            method: "POST", 
                            cache: "no-cache",
                            credentials: "include", 
                            headers: {
                            "Content-Type": "application/json",
                            },
                            redirect: "follow", 
                            body: JSON.stringify(data),
                        });
                        return response.json(); 
                        console.log('Success');
                        } 
                postData();
                $('#loadfetchsend').load;
               

            }
    });
        

</script>

<!-- Fetch Message -->

<script>
    
    async function fetchsend() {
    // const channel_id = localStorage.getItem("channel_id");
    // const server_id = localStorage.getItem("serverID");
    let sRid = svid;
    let cRid =  localStorage.getItem("channel_id");

    const url = `/msg/${sRid}/${cRid}/getlist`;

    const response = await fetch(url, {
        method: "GET", 
        cache: "no-cache",
        credentials: "include", 
        headers: {
        "Content-Type": "application/json",
        },
        redirect: "follow"
    });
    const data = await response.json();
    for (j = 0; j < data.length; j++) {
        // guilda.id = ch[j].id;
       let senderby = data[j].sender;
       let contentby = data[j].content;
       let dateby = data[j].date;
        

        const todochattosend = document.createElement('div');
                const todoProfileDirect = document.createElement('div');
                const todocontentchat = document.createElement('div');
                const todoimage = document.createElement('img');
               
                const todonamechat = document.createElement('div');
                const todoconchat = document.createElement('div');
                const todoitem31 =document.createElement('div');
                

                const todoHeadSix = document.createElement('h6');
                const todoSpan1 = document.createElement('span');
                const todoSpan2 = document.createElement('span');


                const todate = new Date();
                const tododateDate = new Date().toISOString().split('T')[0];
                
                let namemeM = (localStorage.getItem("username"));
                
                todate.getHours() + ":" + todate.getMinutes() 
                

                const nameMember = 'Name ';

                todochattosend.classList.add('chat-to-send');

                todoProfileDirect.classList.add('Profile-Direct');
                todoProfileDirect.style.width='60px';


                todoimage.src ="{{ url_for('static', path='/assets/disquote.png') }}";

                todoProfileDirect.appendChild(todoimage);

                //เสร็จของProfileDirect



                //addclass contentchat
                todocontentchat.classList.add('content-chat');

                //addclass namechat
                todonamechat.classList.add('namechat');
                //addclass conchat
                todoconchat.classList.add('conchat');
                //เอาText เข้า         
                todoconchat.innerHTML=contentby;
                //addclass span1
                todoSpan1.classList.add('name');
                //เอาtext เข้า
                todoSpan1.innerHTML=senderby;
                
                //todoSpan1.innerHTML=nameMember;
                //addclass span1
                todoSpan2.classList.add('date');
                //เอาtext เข้า
                // todoSpan2.innerHTML=tododateDate   + '  ' + todate.getHours() + ":" + todate.getMinutes() ;
                 todoSpan2.innerHTML=dateby
                todoHeadSix.appendChild(todoSpan1);
                todoHeadSix.appendChild(todoSpan2);
                //เอา h6 และ และ div  conchat
                todonamechat.appendChild(todoHeadSix);
                todonamechat.appendChild(todoconchat);
                todocontentchat.appendChild(todonamechat);
                todochattosend.appendChild(todoProfileDirect);
                todochattosend.appendChild(todocontentchat);
                todochatsend.appendChild(todochattosend);
                textsend.value = '';
                
    }
    
    // console.log(data); // log the response to the console
    // const senderby = data('sender');
    // console.log(senderby);
    }fetchsend();


</script>

<script>
    const code_invite = (localStorage.getItem("invitation"));
    let invitelink_btn = document.getElementById('copy-invite');
    invitelink_btn.addEventListener('click', () => {
        curr = window.location.href;
        const url = new URL(curr);
        const newurl = url.origin + url.pathname;
        navigator.clipboard.writeText(newurl + "/" + code_invite)
            .then(() => {
                alert('Text copied to clipboard');
            })
            .catch((err) => {
                alert('Failed to copy text: ', err);
            });
    });
</script>
    

    <!-- TODO:get  ข้อความทั้งหมด -->
    <!-- <script>
    //     async function getmessage() {
    //         let response = await fetch(`/msg${svid}/${channel_id}/getlist`, {
    //             method: 'POST',
    //             credentials: 'include'
    //         }).then(async function (data) {

    //         }
    //         )};
    // </script> -->

<script>
    
    let user_online = (localStorage.getItem("username"));
    let name_box = document.getElementById("online_name");
    name_box.innerHTML = user_online;;  


    let ServerN = (localStorage.getItem("serverName"));
    
    let servername = document.getElementById("sever_name_show");
    servername.innerHTML = ServerN ;;  
</script>


</body>

</html>